#!/bin/bash
set -xeu

PATHS="$BUILDKITE_PLUGIN_SPARSE_CHECKOUT_PATHS"

echo "Working directory: $(pwd)"
echo "Sparse checking out the following paths: $PATHS"

# Clean build every time
REPO_NAME=$(basename "$BUILDKITE_REPO" .git)
cd ..
rm -rf $REPO_NAME
git clone --no-checkout $BUILDKITE_REPO $REPO_NAME && cd $REPO_NAME
git sparse-checkout init --cone

for thisPath in $PATHS; do
	git sparse-checkout add $thisPath
done

git checkout "$BUILDKITE_BRANCH"

buildkite-agent annotate "Sparse checkout of the following paths: $PATHS"
